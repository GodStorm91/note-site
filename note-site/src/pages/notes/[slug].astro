---
import fs from 'node:fs';
import path from 'node:path';
import { marked } from 'marked';
import 'github-markdown-css/github-markdown-light.css';
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const notesDir = path.join(process.cwd(), 'src', 'content', 'notes');
  let files: string[] = [];

  try {
    files = fs.readdirSync(notesDir).filter((f) => f.endsWith('.md') || f.endsWith('.mdx'));
  } catch {
    files = [];
  }

  const paths = files.map((file) => ({
    params: { slug: file.replace(/\.mdx?$/, '') },
  }));

  return paths;
}

const { slug } = Astro.params;

if (!slug) {
  throw new Error('Missing slug');
}

const notesDir = path.join(process.cwd(), 'src', 'content', 'notes');
const filePathMd = path.join(notesDir, `${slug}.md`);
const filePathMdx = path.join(notesDir, `${slug}.mdx`);

let content = '';

if (fs.existsSync(filePathMd)) {
  content = fs.readFileSync(filePathMd, 'utf8');
} else if (fs.existsSync(filePathMdx)) {
  content = fs.readFileSync(filePathMdx, 'utf8');
} else {
  throw new Error(`Note not found for slug: ${slug}`);
}

// Rewrite BearImages relative paths to root-relative so Astro can serve from /public/BearImages
content = content.replace(/\(BearImages\//g, '(/BearImages/');

const title = slug
  .replace(/-/g, ' ')
  .replace(/\b\w/g, (c) => c.toUpperCase());

let html = marked.parse(content, { gfm: true, breaks: false });

// Heuristic: if a <pre><code> block looks like PHP / Tinker REPL
// (starts with >>>, contains php artisan, App\\Models, etc.)
// and has no language class, tag it as language-php so highlight.js
// can color it properly.
html = html.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g, (match, inner) => {
  const text = inner.trim();
  const looksPhp =
    text.startsWith('>>>') ||
    text.startsWith('$') ||
    text.includes('php artisan') ||
    text.includes('App\\\\Models') ||
    text.includes('<?php');
  if (!looksPhp) return match;
  return `<pre><code class="language-php">${inner}</code></pre>`;
});
---

<BaseLayout title={title}>
  <a href="/" class="muted" style="text-decoration: none;">‚Üê Back to notes</a>
  <article
    class="markdown-body card"
    style="margin-top: 1.25rem; padding-top: 1.25rem;"
    set:html={html}
  />
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"
    onload="window.hljs && window.hljs.highlightAll()"
  ></script>
</BaseLayout>
