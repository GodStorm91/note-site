---
import fs from 'node:fs';
import path from 'node:path';
import BaseLayout from "../layouts/BaseLayout.astro";

const notesDir = path.join(process.cwd(), 'src', 'content', 'notes');

const entries = fs.readdirSync(notesDir).filter((f) => f.endsWith('.md') || f.endsWith('.mdx'));

const tagCount = new Map<string, number>();

for (const file of entries) {
  const fullPath = path.join(notesDir, file);
  const raw = fs.readFileSync(fullPath, 'utf8');
  const matches = raw.match(/(^|\s)#([\p{L}\p{N}_/+-]+)/gu) || [];
  const tags = Array.from(
    new Set(
      matches
        .map((m) => m.replace(/^\s*#/, '').trim().toLowerCase())
        .filter((t) => t && !t.startsWith('publish'))
    )
  );
  for (const t of tags) {
    tagCount.set(t, (tagCount.get(t) || 0) + 1);
  }
}

const tags = Array.from(tagCount.entries()).sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));
---

<BaseLayout title="Tags">
  <section class="card">
    <h1 style="margin-top:0; font-size:1.4rem;">Tags</h1>
    {tags.length === 0 ? (
      <p class="muted">Chưa có tag nào (ngoài #publish).</p>
    ) : (
      <ul style="margin:0.75rem 0 0; padding-left:1.1rem;">
        {tags.map(([tag, count]) => (
          <li style="margin-bottom:0.3rem;">
            <a
              href={`/tags/${encodeURIComponent(tag.toLowerCase().replace(/[\s/]+/g, '-'))}`}
              class="tag-pill"
            >
              #{tag}
            </a>
            <span class="muted" style="margin-left:0.4rem; font-size:0.8rem;">{count} note</span>
          </li>
        ))}
      </ul>
    )}
  </section>
</BaseLayout>
